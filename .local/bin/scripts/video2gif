#!/bin/sh

[ -z $1 ] && printf "No arguments given, exiting...\n" && exit 1

vid=$1
filebase=$(basename $1 | cut -d'.' -f1)
start_time=0
duration=60
height=ih/2      # input height halved, can replace with pixels.
width=-1         # keeps aspect ratio, can replace with pixels.
fps=30           # frames per second.

filters="fps=$fps,scale=$width:$height:flags=lanczos,split[s0][s1]"

ffmpeg -ss $start_time                             \
       -i  "$vid"                                  \
       -vf "$filters;[s0]palettegen[p];		   \
       [s1][p]paletteuse"        		   \
	-loop 0 \
       -y  palette.png                             &&
ffmpeg -ss $start_time                             \
       -t  $duration                               \
       -i  "$vid"                                  \
       -i  palette.png                                \
       -lavfi "$filters [x]; [x][1:v] paletteuse"  \
       -y  "$filebase".gif                              &&
rm palette.png
