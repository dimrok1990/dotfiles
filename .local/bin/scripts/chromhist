#!/bin/zsh

# https://junegunn.kr/2015/04/browsing-chrome-history-with-fzf/
# https://github.com/junegunn/fzf/wiki/examples#browsing-history

local cols sep temp_hist

cols=$(( COLUMNS / 3 ))
sep='{::}'
temp_hist="$(mktemp -u)"

[[ $1 = popup ]] && opts="--height=100%"

command cp -f "$HOME"/.config/chromium/Default/History "$temp_hist"

sqlite3 -separator "$sep" "$temp_hist" \
	"select substr(title, 1, $cols), url from urls order by last_visit_time desc" |
		awk -F "$sep" '{printf "%-'$cols's  \x1b[36m%s\x1b[m\n", $1, $2}' |
		fzf --ansi --multi --preview " echo {-1} | readable -q | xargs w3m -T text/html" --preview-window=right:30% $opts | sed 's#.*\(https*://\)#\1#' | setsid -f xargs -r $BROWSER >/dev/null 2>&1

rm -f "$temp_hist"
